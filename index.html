<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>田禾宮・紫微命盤排版系統</title>
    <style>
        /* 基礎樣式設計：採現代簡潔與東方古風結合 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; background-color: #FDFBF7; color: #2C3E50; min-height: 100vh; line-height: 1.6; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* 標題區塊：吉祥物圖片 240px 置於左方 */
        .header { 
            margin-bottom: 30px; 
            padding: 40px 30px; 
            background: linear-gradient(135deg, #A62C2B 0%, #801C1B 100%); 
            border-radius: 24px; 
            color: #F5E6BE; 
            box-shadow: 0 10px 30px rgba(166, 44, 43, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px; 
        }
        .header img { 
            width: 240px; 
            height: auto; 
            border-radius: 25px;
            border: 5px solid #F5E6BE;
            background: white;
            padding: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }
        .header-text { text-align: left; }
        .header h1 { font-size: 42px; letter-spacing: 12px; margin-bottom: 8px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 18px; letter-spacing: 4px; opacity: 0.9; }
        
        /* 輸入區域 */
        .input-section { background: #FFFFFF; padding: 30px; border-radius: 15px; border: 2px solid #A62C2B; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .input-section h2 { color: #A62C2B; margin-bottom: 20px; font-size: 22px; border-left: 6px solid #A62C2B; padding-left: 15px; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: bold; margin-bottom: 8px; color: #555; font-size: 14px; }
        .form-group input, .form-group select { padding: 12px; border: 1px solid #D1C4B2; border-radius: 8px; font-size: 15px; background: #FFF; transition: all 0.3s; }
        
        .btn-calculate { background-color: #A62C2B; color: #F5E6BE; border: none; border-radius: 10px; font-weight: bold; font-size: 20px; padding: 18px 40px; cursor: pointer; transition: all 0.3s; width: 100%; letter-spacing: 3px; }
        .btn-calculate:hover { background-color: #C13F3E; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(166, 44, 43, 0.3); }
        
        .result-section { display: none; }
        .result-section.active { display: block; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 命盤圖形樣式 */
        .chart-container { background: #F4EBE2; border-radius: 20px; padding: 30px; margin-bottom: 40px; box-shadow: inset 0 0 30px rgba(0,0,0,0.05); }
        .chart-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 10px; max-width: 800px; margin: 0 auto; }
        
        .palace { background: #FFF8F2; border: 2px solid #A62C2B; border-radius: 10px; padding: 12px; min-height: 160px; position: relative; transition: all 0.3s; }
        .palace:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 5px 15px rgba(166, 44, 43, 0.1); }
        .palace.life-palace { background: #FFF0F0; border-width: 3px; border-color: #A62C2B; }
        
        .palace-name { text-align: center; font-weight: bold; font-size: 18px; color: #A62C2B; margin-bottom: 8px; border-bottom: 1px solid #E0D5C1; padding-bottom: 5px; }
        
        .main-stars { font-size: 14px; color: #A62C2B; line-height: 1.6; font-weight: bold; }
        .main-stars span { display: inline-block; margin: 2px 4px; border-bottom: 1px solid rgba(166, 44, 43, 0.1); }
        
        .sec-stars { font-size: 11px; color: #666; position: absolute; top: 45px; right: 8px; text-align: right; }
        .stem-branch { position: absolute; bottom: 8px; right: 8px; font-size: 14px; font-weight: bold; color: #8E7341; }
        .age-range { position: absolute; bottom: 8px; left: 8px; font-size: 12px; color: #777; font-family: Consolas, monospace; }
        
        /* 中央方塊 2x2 置中 */
        .center-palace { 
            background: white; 
            border: 5px double #A62C2B; 
            border-radius: 15px; 
            padding: 20px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 32px; 
            color: #A62C2B; 
            font-weight: bold; 
            grid-column: span 2; 
            grid-row: span 2; 
            box-shadow: inset 0 0 20px rgba(166, 44, 43, 0.08);
            letter-spacing: 12px;
            line-height: 1.5;
        }
        
        /* 分析報告樣式 */
        .analysis-content { background: #FFFEFA; padding: 50px; border-radius: 24px; border: 1px solid #E0D5C1; max-width: 850px; margin: 0 auto; box-shadow: 0 15px 50px rgba(0,0,0,0.05); }
        .analysis-header { text-align: center; margin-bottom: 40px; border-bottom: 4px solid #A62C2B; padding-bottom: 25px; }
        .analysis-header h2 { color: #A62C2B; font-size: 32px; letter-spacing: 6px; margin-bottom: 12px; }
        .analysis-header p { color: #8E7341; font-size: 16px; letter-spacing: 4px; }
        
        .info-box { background-color: #FDFBEE; padding: 30px; border-radius: 12px; border: 1.5px solid #D4AF37; margin-bottom: 40px; }
        .info-box table { width: 100%; font-size: 18px; border-collapse: collapse; }
        .info-box td { padding: 10px; }
        .info-box .highlight { color: #A62C2B; font-weight: bold; }
        
        .section-title { color: #FFF; background: #A62C2B; padding: 18px 25px; border-radius: 10px 10px 0 0; margin-bottom: 0; font-size: 20px; letter-spacing: 3px; }
        .section-content { background: #FFF; border: 1px solid #A62C2B; padding: 35px; border-radius: 0 0 10px 10px; line-height: 2.2; font-size: 16px; margin-bottom: 50px; }
        
        .quote { color: #7B5E26; font-style: italic; border-bottom: 2px solid #FDFBEE; padding-bottom: 25px; margin-bottom: 40px; font-size: 18px; line-height: 1.8; text-align: center; }
        
        .analysis-item { margin-bottom: 40px; border-bottom: 1px dashed #E0D5C1; padding-bottom: 25px; }
        .analysis-item:last-child { border-bottom: none; }
        .analysis-item b { color: #A62C2B; font-size: 20px; display: block; margin-bottom: 15px; border-left: 6px solid #A62C2B; padding-left: 15px; }
        
        .year-prediction { margin-bottom: 50px; border: 2px solid #8E7341; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 30px rgba(142, 115, 65, 0.1); }
        .year-prediction.next-year { border-color: #A62C2B; box-shadow: 0 10px 30px rgba(166, 44, 43, 0.1); }
        .year-header { background: #8E7341; color: #FFF; padding: 25px; text-align: center; font-weight: bold; font-size: 20px; letter-spacing: 3px; }
        .year-prediction.next-year .year-header { background: #A62C2B; }
        
        .year-content { padding: 40px; background: #FFFEFA; }
        
        .si-hua-tag { display: inline-block; background: #F2DEDE; color: #A62C2B; padding: 10px 30px; border-radius: 40px; font-weight: bold; font-size: 16px; margin-bottom: 25px; border: 1px solid #EBCCD1; }
        .year-prediction.next-year .si-hua-tag { background: #FDFBEE; color: #8E7341; border: 1px solid #D4AF37; }
        
        .advice-box { background: #F9F5EF; padding: 25px; border-left: 10px solid #8E7341; margin-top: 30px; border-radius: 4px; }
        .year-prediction.next-year .advice-box { background: #FDF2F2; border-left-color: #A62C2B; }
        .advice-box b { color: #8E7341; display: block; margin-bottom: 12px; font-size: 18px; }
        
        .footer-msg { padding: 40px; background-color: #FDF2F2; border: 2px solid #F2DEDE; border-radius: 20px; text-align: center; line-height: 2.2; margin-top: 50px; }
        .footer-msg b { color: #A62C2B; font-size: 22px; letter-spacing: 5px; display: block; margin-bottom: 12px; }
        
        @media (max-width: 992px) {
            .header { flex-direction: column; text-align: center; gap: 20px; }
            .header img { width: 150px; }
            .header-text { text-align: center; }
            .header h1 { font-size: 36px; letter-spacing: 8px; }
            .chart-grid { grid-template-columns: repeat(2, 1fr); max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="13.png" alt="田禾宮吉祥物" id="mascotImg" onerror="this.alt='田禾宮圖示'">
            <div class="header-text">
                <h1>田 禾 宮</h1>
                <p>專業紫微命盤排版系統 (大師深度詳批版)</p>
            </div>
        </div>
        
        <div class="input-section">
            <h2>緣主資料錄入</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>姓名</label>
                    <input type="text" id="name" placeholder="請輸入姓名" value="">
                </div>
                <div class="form-group">
                    <label>出生年份 (西元)</label>
                    <input type="number" id="year" min="1900" max="2100" value="1983">
                </div>
                <div class="form-group">
                    <label>月份</label>
                    <select id="month">
                        <option value="1">1月</option><option value="2">2月</option>
                        <option value="3">3月</option><option value="4">4月</option>
                        <option value="5">5月</option><option value="6">6月</option>
                        <option value="7">7月</option><option value="8" selected>8月</option>
                        <option value="9">9月</option><option value="10">10月</option>
                        <option value="11">11月</option><option value="12">12月</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>日期</label>
                    <select id="day"></select>
                </div>
                <div class="form-group">
                    <label>出生時辰</label>
                    <select id="hour">
                        <option value="0">子 (23-01)</option><option value="1">丑 (01-03)</option>
                        <option value="2">寅 (03-05)</option><option value="3">卯 (05-07)</option>
                        <option value="4">辰 (07-09)</option><option value="5" selected>巳 (09-11)</option>
                        <option value="6">午 (11-13)</option><option value="7">未 (13-15)</option>
                        <option value="8">申 (15-17)</option><option value="9">酉 (17-19)</option>
                        <option value="10">戌 (19-21)</option><option value="11">亥 (21-23)</option>
                    </select>
                </div>
            </div>
            <button class="btn-calculate" onclick="runAnalysis()">開啟天機・獲取個人專屬深度解析</button>
        </div>
        
        <div class="result-section" id="result">
            <div class="chart-container">
                <div class="chart-grid" id="chartGrid"></div>
            </div>
            <div class="analysis-content" id="analysisContent"></div>
        </div>
    </div>

    <script>
        // --- 核心資料數據庫 (修正重複定義錯誤，整合至一處) ---
        const LUNAR_DATA = [
            0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
            0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
            0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
            0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
            0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
            0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0,
            0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
            0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0,
            0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0, 0x14b63, 0x09370,
            0x049f8, 0x04970, 0x064b0, 0x168a6, 0x0ea50, 0x06b20, 0x1a6c4, 0x0aae0, 0x0a2e0, 0x0d2e3,
            0x0c960, 0x0d557, 0x0d4a0, 0x0da50, 0x05d55, 0x056a0, 0x0a6d0, 0x055d4, 0x052d0, 0x0a9b8,
            0x0a950, 0x0b4a0, 0x0b6a6, 0x0ad50, 0x055a0, 0x0aba4, 0x0a5b0, 0x052b0, 0x0b273, 0x06930,
            0x07337, 0x06aa0, 0x0ad50, 0x14b55, 0x04b60, 0x0a570, 0x054e4, 0x0d260, 0x0e968, 0x0d520,
            0x0daa0, 0x16aa6, 0x056d0, 0x04ae0, 0x0a9d4, 0x0a4d0, 0x0d150, 0x0f252, 0x0d520
        ];

        const SI_HUA_DATA = {
            "甲": "廉貞化祿、破軍化權、武曲化科、太陽化忌", "乙": "天機化祿、天梁化權、紫微化科、太陰化忌",
            "丙": "天同化祿、天機化權、文昌化科、廉貞化忌", "丁": "太陰化祿、天同化權、天機化科、巨門化忌",
            "戊": "貪狼化祿、太陰化權、右弼化科、天機化忌", "己": "武曲化祿、貪狼化權、天梁化科、文曲化忌",
            "庚": "太陽化祿、武曲化權、太陰化科、天同化忌", "辛": "巨門化祿、太陽化權、文曲化科、文昌化忌",
            "壬": "天梁化祿、紫微化權、左輔化科、武曲化忌", "癸": "破軍化祿、巨門化權、太陰化科、貪狼化忌"
        };

        const STAR_DB = {
            "紫微": { 
                "intro": "紫微星為北斗之主，至尊之星。主掌地位、權力、尊榮與自我管理。性格高傲、自尊心極強，具領袖風範，如同古代帝王般追求卓越。", 
                "career": "天生具備管理潛能，適合擔任核心決策者、創業者或高端顧問。在複雜的人際佈局中能發揮最大光芒，但需避免獨斷獨行。", 
                "wealth": "財運主貴，錢財多隨社會地位與名聲而來。擅長資產大格局配置，理財風格穩重。需注意避免因面子產生的無謂支出。", 
                "social": "社交圈層次極高，多為菁英。感情中較強勢，擇偶極其重視門當戶對與社會評價，需學習給予伴侶足夠尊重。", 
                "health": "主掌脾胃與心腦血管。應防範中風、高血壓或長期神經緊繃。建議培養冥想或遠足等放鬆身心的愛好。", 
                "annual": "【地位鞏固年】今年是展現領袖特質的最佳時機，有利於職位躍遷與名聲遠播。即便遇阻礙，只要堅守原則必能迎刃而解。" 
            },
            "天機": { 
                "intro": "天機星為南斗之首，智慧之星。主智慧、策劃、邏輯分析與快速變動。心性慈悲且思維敏捷，是智庫型的核心靈魂。", 
                "career": "適合資訊科技、企劃研發、顧問等需高度邏輯推理領域。應專注於深耕一門核心技術，避免好奇心過廣而博而不精。", 
                "wealth": "財運主『變動』，錢財常來自知識變現、技術紅利。理財風格敏捷，對新商機反應快，但防思慮過度導致猶豫不決。", 
                "social": "觀察入微，是極佳的傾聽者。擇偶偏好能產生靈魂共鳴的人。情感細膩，但也容易因過於敏感而產生自我內耗。", 
                "health": "主掌神經系統、肝膽機能。容易因大腦運作過度而患有焦慮、失眠。建議建立規律作息，並增加戶外活動。", 
                "annual": "【智慧轉型年】環境變動劇烈，變動中藏有機遇。今年有利於取得證照或高端研發。不被紛擾影響核心方向會有突破。" 
            },
            "太陽": { 
                "intro": "太陽星為中天主星，光明之源。主奉獻、名聲、開拓力與官祿。性格正直坦蕩，具有極強的公眾服務熱誠與使命感。", 
                "career": "適合教育傳播、公共法律、政治外交或需高度曝光產業。天生發光體，適合開拓新市場，但需注意工作與生活的平衡。", 
                "wealth": "財運具開創性，錢財隨社會地位而來。理財風格慷慨。建議將流動資金轉化為穩健長期資產。大格局運作更適合您。", 
                "social": "交友極廣，常是團體靈魂人物。在感情中男性具保護慾，女性則顯得幹練。擇偶傾向陽光正直對象。需學習柔性溝通。", 
                "health": "主掌心臟、眼睛、血壓與循環系統。體質偏熱，防範心血管疾病或視力退化。建議飲食清淡，遠離菸酒。", 
                "annual": "【光芒四射年】長期努力將被社會看見，名聲帶動財富，有利推廣個人品牌。只要維持良好商譽，財富將穩定增長。" 
            },
            "武曲": { 
                "intro": "武曲星為北斗正財星。主決斷、實幹、剛毅與財富積累。執行力冠絕群星，是典型的白手起家實幹家。", 
                "career": "金融管理、軍警執法、製造工程佼佼者。處事雷厲風行，對目標有近乎執著的追求。誠信與專業是你最強大的資產。", 
                "wealth": "財星坐命，對金錢敏銳。擅長實體投資、資產積累與嚴謹數字管理。正財運極佳，財富來自本業長期耕耘。", 
                "social": "朋友雖少但皆為患難之交。感情中顯得較為木訥或剛強，易給伴侶冷漠感。擇偶傾向同樣務實、能共同創業的夥伴。", 
                "health": "主掌呼吸系統、肺部與大腸機能。體質偏燥，防範氣管發炎或過敏。建議多從事有氧運動，保養重點在於排泄順暢。", 
                "annual": "【實質獲利年】今年是成果收割期。凡事以數據、合約與實效為準。財務指標將有突破性增長，極利於資產優化配置。" 
            },
            "天同": { 
                "intro": "天同星為南斗福德星。主溫和、知足、休閒、審美與內心和諧。性格樂觀開朗，具有極佳生活情趣，是幸運與福氣的代名詞。", 
                "career": "適合藝術創意、服務業、行政管理。在充滿和諧氣氛的團隊中能發揮潛能。需具能力的導師引導，方能取得顯著成就。", 
                "wealth": "財運平穩，常有貴人財或意外福報財。理財心態輕鬆知足。需防範因安逸心態導致規劃停滯。建議規律儲蓄積少成多。", 
                "social": "人際關係極佳，是社交潤滑劑。異性緣帶浪漫色彩，易吸引溫暖特質對象。擇偶宜選成熟穩重者以獲得穩定感。", 
                "health": "主掌泌尿系統、排泄系統與內分泌平衡。防範體重超標或代謝問題導致水腫。建議建立低糖飲食習慣並維持運動。", 
                "annual": "【福星高照年】整體運勢平順穩定。非常適合修身養性、修復家族關係。內心幸福感提升，也有助於獲得長輩饋贈。" 
            },
            "廉貞": { 
                "intro": "廉貞星為北斗之星。主官祿、競爭、外交魅力與自我自律。性格細膩且具強大觀察力，具完美主義傾向與獨特藝術磁場。", 
                "career": "適合精密科技、設計研發、外交或法律。能從混亂資訊中梳理出脈絡。要注意避免因堅持己見而引發口舌。職場風格專業。", 
                "wealth": "理財風格獨到且具備偏財運。財富有波段震盪性。絕對避開灰色地帶以免法律風險。建議投資專業技術提升或品牌打造。", 
                "social": "具備強烈吸引力，社交風格精緻。異性緣旺且關係深刻。擇偶宜選才華對等伴侶。需防範複雜情感糾紛。", 
                "health": "主掌血液循環、免疫系統與心理健康。情緒起伏容易導致自律神經失調。建議定期運動放鬆神經，遠離加工食品。", 
                "annual": "【機遇挑戰年】今年才華將大放異彩，但也伴隨各種口舌是非。只要守法、低調，利用流年能量，必能化挑戰為大機運。" 
            },
            "天府": { 
                "intro": "天府星為南斗主星，財庫之司。主守成、穩健、包容與資源整合。性格沉穩可靠，具備天生管理長才與守護意識。", 
                "career": "適合行政管理、金融銀行、房產開發。處事周全信賴。你是團隊最好的行政支柱，適合處理需要耐心的長線穩定專案。", 
                "wealth": "財庫星。財運穩定且積累能力強。擅長規律儲蓄與不動產投資。財富呈現階梯式上升。您具備存錢天性。", 
                "social": "寬厚慈祥，社交層次分明且穩定。是他人依賴的避風港。擇偶重視社會地位與穩定性。情緣通常穩定長久。", 
                "health": "主掌消化系統、脾胃與代謝機能。因重視食補，需防範腸胃負擔過重或消化不良。建議維持清淡飲食。", 
                "annual": "【穩健積累年】今年不宜進行跨度太大、高風險開拓，適合優化與盤點資產。家宅運旺，利於改善居住環境或置產。" 
            },
            "太陰": { 
                "intro": "太陰星為中天主星，月之精華。主富貴、田宅、感性與細膩直覺。性格柔順內斂，具有母性般的包容心與富裕感。", 
                "career": "適合財務審計、諮商、文藝設計。在精準預算、細節處理或情感共鳴環境具優勢。在競爭中需建立心理防線。", 
                "wealth": "財富有『細水長流』的優雅感。理財風格保守求穩，對不動產投資有特殊天賦。對錢財有極高安全感需求。", 
                "social": "溫柔體貼且善於傾聽。追求情緒穩定與絕對安全感。擇偶偏好陽光、能給予穩定未來承諾對象。穩定度取決於內心。", 
                "health": "主掌肝腎系統、女性內分泌與情緒調節。容易患有貧血、失眠。心理健康是基石。建議親近自然進行磁場調劑。", 
                "annual": "【內在修煉年】利於深度研修進修、取得專業證照。心境平靜會為您帶來極優質合作機緣與貴人扶持。" 
            },
            "貪狼": { 
                "intro": "貪狼星為北斗之星，慾望之神。主才藝、社交、變革與慾望。性格多才多藝、靈活外向，對新奇事物有強烈探索慾。", 
                "career": "適合創意廣告、商務談判、演藝或前瞻科技。適應力強，中年後應專注單一技術深耕。職場風格靈活能處非標挑戰。", 
                "wealth": "財運具強烈投機與爆發色彩。擅用人際獲取財訊。錢財流動大，豐收年應鎖定固定資產，防範財來財去。", 
                "social": "社交明星，魅力四射。異性緣極旺盛但也伴隨諸多是非紛擾。擇偶宜選成熟、能引領進步的對象。需注意社交邊界。", 
                "health": "主掌肝膽機能、生殖系統。因交際應酬頻繁，嚴防肝功能負荷過重。保養重點在高品質睡眠，避免熬夜。", 
                "annual": "【靈性考驗年】外界誘惑顯著增多。若能將精力轉向專業技術或心靈成長，今年將有非凡收穫；反之則防是非損財。" 
            },
            "巨門": { 
                "intro": "巨門星為北斗是非之星，溝通之主。主觀察、懷疑、求真與表達。性格心思縝密，具備極強分析邏輯與穿透力。", 
                "career": "適合法律、教育、媒體、專業評論。適合『口舌生財』職務。擅長發現系統漏洞。要注意磨練溝通藝術減少敵意。", 
                "wealth": "錢財來自專業深度積累。理財注重邏輯與實證。防範因口舌紛爭或文書瑕疵導致損財。適合建立高門檻防禦資產。", 
                "social": "慢熟且愛恨分明，朋友雖少但皆為患難。擇偶極重忠誠度與智商。情感世界內斂，需防猜疑心破壞關係。", 
                "health": "主掌脾胃機能、呼吸道。心理壓力對健康影響顯著，防慢性發炎。建議學習樂觀哲學。保養重點在咽喉养护。", 
                "annual": "【專業突破年】流年口舌雖多，正是展現分析力與事實公信力機會。堅守誠信，負面聲浪終將轉為認可您的權威資本。" 
            },
            "天相": { 
                "intro": "天相星為南斗印星，主忠厚、規矩、和諧與印信標準。其性格優雅得體，重視社會評價、秩序與美感。", 
                "career": "適合中層管理、行政協調官、精品業。你是團隊最佳執行者，職場風格溫和受信任。適合在穩定標準環境發揮。", 
                "wealth": "正財收入穩定。理財重視質感而不重投機，積累靠時間複利效應。天生對金錢管理具平衡感，不易現財務危機。", 
                "social": "受人高度信任。情緣重視儀式感與社會對等。擇偶傾向溫文儒雅對象。常能獲得伴侶實質支持。", 
                "health": "主掌腎臟、皮膚與內分泌。防範皮膚過敏或腎機能負擔。心理健康對氣色影響顯著。保養重點在高品質純淨飲水。", 
                "annual": "【和諧運作年】極其有利於簽署重要合約或調停。誠信是今年核心資產，依規矩行事不僅能獲利，還能贏得長遠商譽。" 
            },
            "天梁": { 
                "intro": "天梁星為南斗長壽之星，蔭庇之神。主慈悲、化解、長者風範。性格成熟穩重，具備逢凶化吉能量，是化難之星。", 
                "career": "適合教育、醫療、公益、法律審核。你是團隊定海神針，具極高公信力。適合在監管單位發展，能靠聲望獲利。", 
                "wealth": "財運帶顯著『後福』與『提攜』特質。錢財多來自長輩、祖產或技術紅利。理財極保守。淡泊態度反而常吸穩財。", 
                "social": "人際具長者色彩，公正但孤高。感情中扮演照顧者。是排解紛爭的仲裁者。情緣中具備蔭庇伴侶的力量。", 
                "health": "主掌消化系統、骨骼。雖長壽，但防慢性關節炎或脾胃虛寒。建議增加骨質鍛鍊。保養重點在脊椎關節定期伸展。", 
                "annual": "【逢凶化吉年】遇阻礙莫慌，貴人必在關鍵時刻現身。適合修補人際關係、健康檢查。轉化能量強，能解決多年難題。" 
            },
            "七殺": { 
                "intro": "七殺星為南斗將星。主瞬間爆發、決斷、獨立。性格剛烈獨立，具備強大生存意志，是不畏挑戰的鬥士。", 
                "career": "適合創業開拓、銷售對抗、軍警。不耐框架，追求瞬間決斷成就感。適合動盪環境開疆闢土。需磨練長遠耐心。", 
                "wealth": "財富有冒險性。理財風格激進，易短時獲鉅利但也伴隨風險。中年後宜資產代管。宜專注單一高獲利項目。", 
                "social": "愛恨分明，肝膽相照。不屑虛偽社交。情緣中主導慾強。擇偶傾向堅毅伴侶。需嚴防衝動下的情感決策。", 
                "health": "主掌肺部、大腸與外傷防護。因過度體力損耗，防呼吸道發炎。建議學習瑜伽或呼吸訓練以中和剛強能量。", 
                "annual": "【開拓進取年】能量異常充沛，利啟動宏大計畫。只要細節覆核，避免躁進，下半年將有里程碑式跨越成長收穫。" 
            },
            "破軍": { 
                "intro": "破軍星為北斗變革之主。主消耗、破壞後的重組。性格求新求變，具備強烈破舊立新衝動與開創力。", 
                "career": "電商開拓、市場重組、轉型顧問。不耐守成安穩。適合處理殘局或開荒。要注意在『破』中保留有價值核心資源。", 
                "wealth": "財運大幅波動，先損後得。擅長打破壟斷結構。理財聚焦高價值研發。建議嚴格執行停損，不宜穩定定存。", 
                "social": "特立獨行。在社交中容易給人極端印象。感情勇於付出但也伴隨強烈佔有慾。擇偶宜選寬容、具藝術修養者。", 
                "health": "主掌血液、生殖、整體免疫。體質易損耗，防過度勞累導致免疫崩潰。重視深度睡眠，保養重點在徹底排毒。", 
                "annual": "【徹底革新年】適合主動執行斷捨離。主動變革將比被動等待更具生機。秩序重組後將帶來前所未有的繁榮。" 
            }
        };

        const LINKAGE_DB = {
            "紫微天府": "【紫府同宮格】兩大主星同坐，格局宏大。性格極度穩重，做事滴水不漏。能在現代商場中建立穩定權力架構。",
            "太陽巨門": "【巨日同臨格】太陽光芒驅散巨門猜疑。利於異國發展，具跨國外交與國貿天賦。名聲地位並重，中晚年權威顯赫。",
            "武曲貪狼": "【武貪同行格】大器晚成組合。早年多磨難，三十五歲後能量爆發。兼具商業機敏與軍警勇武，是實幹領袖。",
            "天機太陰": "【機月同臨格】思維極縝密，具企劃行政天賦。在大型機構擔任決策幕僚能發揮最大光芒。性格溫厚一生穩定。",
            "廉貞天相": "【廉相守命格】兼具法規正義與公關手腕。形象極佳，能在混亂中建立新標準，適合法律或高端品牌領域。",
            "紫微貪狼": "【桃花犯主格】社交魅力極強。若能專注事業，將是極強的跨界公關命格。需注意慾望控制，將能量轉向創意產出。"
        };

        // --- 核心邏輯處理 ---
        function initDays() {
            const daySelect = document.getElementById('day');
            const month = parseInt(document.getElementById('month').value);
            const year = parseInt(document.getElementById('year').value);
            const daysInMonth = new Date(year, month, 0).getDate();
            daySelect.innerHTML = '';
            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i; option.textContent = i + '日';
                if (i === 19) option.selected = true; // 預設 19 日
                daySelect.appendChild(option);
            }
        }

        class ZiWeiEngine {
            constructor() { this.palaceOrder = ["命宮", "兄弟", "夫妻", "子女", "財帛", "疾厄", "遷移", "交友", "官祿", "田宅", "福德", "父母"]; }
            calculateChart(ly, lm, ld, hourIdx) {
                const lifePos = (2 + (lm - 1) - hourIdx + 12) % 12;
                const palaces = [];
                for (let i = 0; i < 12; i++) {
                    const idx = (lifePos - i + 12) % 12;
                    palaces[idx] = { name: this.palaceOrder[i], branch: BRANCHES[idx], stem: "", main_stars: [], sec_stars: [], age_range: "" };
                }
                const yearStemIdx = (ly - 4) % 10;
                const startStemIdx = ((yearStemIdx % 5) * 2 + 2) % 10;
                for (let i = 0; i < 12; i++) {
                    const currPos = (2 + i) % 12;
                    palaces[currPos].stem = STEMS[(startStemIdx + i) % 10];
                }
                const lifePalace = palaces[lifePos];
                const phase = this.getPhase(lifePalace.stem, lifePalace.branch);
                const ziweiPos = this.getZiweiPos(ld, phase);
                this.setMainStars(palaces, ziweiPos);
                palaces[(4 + hourIdx) % 12].sec_stars.push("文曲");
                palaces[(10 - hourIdx + 12) % 12].sec_stars.push("文昌");
                palaces[(4 + lm - 1) % 12].sec_stars.push("左輔");
                palaces[(10 - (lm - 1) + 12) % 12].sec_stars.push("右弼");
                for (let i = 0; i < 12; i++) {
                    const startAge = phase + i * 10;
                    palaces[(lifePos + i) % 12].age_range = `${startAge}-${startAge + 9}`;
                }
                return { palaces, phase, lifePos };
            }
            getPhase(s, b) {
                const n = { 2: ["甲申","乙酉","丙辰","丁巳","甲寅","乙卯","壬戌","癸亥","丙戌","丁亥"], 3: ["壬午","癸未","庚寅","辛卯","戊戌","己亥","壬子","癸醜","庚申","辛酉"], 4: ["甲子","乙丑","壬申","癸酉","庚辰","辛巳","甲午","乙未","壬寅","癸卯"], 5: ["庚午","辛未","戊寅","己卯","丙戌","丁亥","庚子","辛丑","戊申","己酉"], 6: ["丙寅","丁卯","甲戌","乙亥","戊子","己丑","丙申","丁酉","甲辰","乙巳"] };
                const t = s + b; for (let p in n) { if (n[p].includes(t)) return parseInt(p); } return 2;
            }
            getZiweiPos(d, p) { let q = Math.floor(d/p), r = d%p; if(r===0) return (2+q-1)%12; let m = p-r; return (m%2===1) ? (2+q+1-m+12)%12 : (2+q+1+m)%12; }
            setMainStars(ps, zv) {
                const zvs = ["紫微","天機","太陽","武曲","天同","廉貞"], zvo = [0,-1,-3,-4,-5,-8];
                zvs.forEach((s,i) => ps[(zv+zvo[i]+12)%12].main_stars.push(s));
                const tf = (10-zv+12)%12, tfs = ["天府","太陰","貪狼","巨門","天相","天梁","七殺","破軍"], tfo = [0,1,2,3,4,5,6,10];
                tfs.forEach((s,i) => ps[(tf+tfo[i]+12)%12].main_stars.push(s));
            }
        }

        function renderChart(palaces) {
            const chartGrid = document.getElementById('chartGrid');
            chartGrid.innerHTML = '';
            const posMap = [{p:3,r:0,c:0},{p:4,r:0,c:1},{p:5,r:0,c:2},{p:6,r:0,c:3},{p:2,r:1,c:3},{p:1,r:2,c:3},{p:0,r:3,c:3},{p:11,r:3,c:2},{p:10,r:3,c:1},{p:9,r:3,c:0},{p:8,r:2,c:0},{p:7,r:1,c:0}];
            const grid = Array(4).fill().map(() => Array(4).fill(null));
            posMap.forEach(pos => { grid[pos.r][pos.c] = palaces[pos.p]; });

            for (let r = 0; r < 4; r++) {
                for (let c = 0; c < 4; c++) {
                    if (r === 1 && c === 1) {
                        const cell = document.createElement('div');
                        cell.className = 'center-palace';
                        cell.innerHTML = '田<br>禾<br>宮';
                        chartGrid.appendChild(cell); continue;
                    }
                    if ((r === 1 && c === 2) || (r === 2 && c === 1) || (r === 2 && c === 2)) continue;
                    const palace = grid[r][c];
                    const cell = document.createElement('div');
                    if (palace) {
                        cell.className = 'palace' + (palace.name === '命宮' ? ' life-palace' : '');
                        cell.innerHTML = `
                            <div class="palace-name">${palace.name}</div>
                            <div class="main-stars">${palace.main_stars.map(s => `<span>${s}</span>`).join('')}</div>
                            <div class="sec-stars">${palace.sec_stars.map(s => `<div>${s}</div>`).join('')}</div>
                            <span class="stem-branch">${palace.stem}${palace.branch}</span>
                            <span class="age-range">${palace.age_range}</span>
                        `;
                    } else { cell.className = 'empty-cell'; }
                    chartGrid.appendChild(cell);
                }
            }
        }

        function renderAnalysis(name, lDate, palaces, lifePos) {
            const [ly, lm, ld] = lDate;
            const birthStem = STEMS[(ly - 4) % 10];
            const thisYear = new Date().getFullYear();
            const stemThis = STEMS[(thisYear - 4) % 10];
            const branchThis = BRANCHES[(thisYear - 4) % 12];
            const nextYear = thisYear + 1;
            const stemNext = STEMS[(nextYear - 4) % 10];
            const branchNext = BRANCHES[(nextYear - 4) % 12];

            const lifePalace = palaces[lifePos];
            let starsToAnalyze = [];
            let isBorrowed = false;
            if (lifePalace.main_stars.length > 0) {
                starsToAnalyze = lifePalace.main_stars;
            } else {
                const migrationIdx = (lifePos + 6) % 12;
                starsToAnalyze = palaces[migrationIdx].main_stars;
                isBorrowed = true;
            }
            if (starsToAnalyze.length === 0) starsToAnalyze = ["紫微"];

            // 聯動格局
            let linkageText = "";
            const sortedStr = [...starsToAnalyze].sort().join('');
            for (let key in LINKAGE_DB) {
                let match = true;
                for (let s of key) { if (!sortedStr.includes(s)) match = false; }
                if (match) {
                    linkageText = `<div class="info-box" style="border-color:#A62C2B; background:#FFF0F0;"><b style="color:#A62C2B; font-size:22px;">🔮 格局聯動解析：</b><p style="margin-top:10px;">${LINKAGE_DB[key]}</p></div>`;
                    break;
                }
            }

            let fullAnalysisHtml = "";
            let comboIntro = "";
            let comboAnnual = "";

            starsToAnalyze.forEach(s => {
                const info = STAR_DB[s];
                comboIntro += (comboIntro ? " 與 " : "") + info.intro;
                fullAnalysisHtml += `
                    <div class="analysis-item">
                        <b>💼 【${s}星】事業潛力深度分析：</b>
                        <p>${info.career}</p>
                    </div>
                    <div class="analysis-item">
                        <b>💰 【${s}星】財富理財深度分析：</b>
                        <p>${info.wealth}</p>
                    </div>
                    <div class="analysis-item">
                        <b>🤝 【${s}星】人際情緣深度分析：</b>
                        <p>${info.social}</p>
                    </div>
                    <div class="analysis-item">
                        <b>🛡️ 【${s}星】健康調養深度建議：</b>
                        <p>${info.health}</p>
                    </div>
                `;
                comboAnnual += `<li>【${s}星】${info.annual}</li>`;
            });

            const html = `
                <div class="analysis-header">
                    <h2>田 禾 宮 ・ 專 業 命 理 詳 批</h2>
                    <p>年度動態核心分析報告 (偵測年份：${thisYear}-${nextYear})</p>
                </div>
                <div class="info-box">
                    <table>
                        <tr>
                            <td><b>緣主姓名：</b> ${name}</td>
                            <td><b>命主核心：</b> <span class="highlight">${starsToAnalyze.join('、')}星坐命 ${isBorrowed ? "(借對宮)" : ""}</span></td>
                        </tr>
                        <tr>
                            <td><b>農曆生辰：</b> ${ly}(${birthStem})年${lm}月${ld}日</td>
                            <td><b>流年運勢：</b> ${thisYear}為${stemThis}${branchThis}年</td>
                        </tr>
                    </table>
                </div>

                ${linkageText}

                <div style="margin-bottom: 50px;">
                    <div class="section-title">【本命格局詳盡深度解析】</div>
                    <div class="section-content">
                        <p class="quote">「${comboIntro}」</p>
                        ${fullAnalysisHtml}
                    </div>
                </div>

                <div class="year-prediction">
                    <div class="year-header">今年展望：西元 ${thisYear} (${stemThis}${branchThis}) 年</div>
                    <div class="year-content">
                        <div style="text-align: center;"><span class="si-hua-tag">流年四化：${SI_HUA_DATA[stemThis]}</span></div>
                        <p><b>【本年度整體趨勢】</b><br><ul style="padding-left:20px; margin-top:15px; line-height:2;">${comboAnnual}</ul></p>
                        <div class="advice-box">
                            <b>🔮 師父指引：</b>
                            <p>本年度受「${SI_HUA_DATA[stemThis].split('、').pop()}」能量引動,切記「穩中求進」。應先沉澱情緒再決定重大事項。保持正直之心是改命捷徑。</p>
                        </div>
                    </div>
                </div>

                <div class="year-prediction next-year">
                    <div class="year-header">明年展望：西元 ${nextYear} (${stemNext}${branchNext}) 年</div>
                    <div class="year-content">
                        <div style="text-align: center;"><span class="si-hua-tag">預計流年四化：${SI_HUA_DATA[stemNext]}</span></div>
                        <p>明年對您而言是「厚積薄發」的一年,利於暗財積累與技術深耕。口舌是非增加,應智慧化解。</p>
                        <div class="advice-box">
                            <b>🔮 師父叮嚀：</b>
                            <p>受流年引動影響,凡事不宜躁進。財務管理上適合穩定配置。預則立,不預則廢。</p>
                        </div>
                    </div>
                </div>

                <div class="footer-msg">
                    <b>師 父 寄 語</b>
                    <p>「紫微星盤為人生之地圖,行善積德是改命的最佳捷徑。」</p>
                </div>
            `;
            document.getElementById('analysisContent').innerHTML = html;
        }

        function runAnalysis() {
            const name = document.getElementById('name').value || "緣主";
            const year = parseInt(document.getElementById('year').value);
            const month = parseInt(document.getElementById('month').value);
            const day = parseInt(document.getElementById('day').value);
            const hourIdx = parseInt(document.getElementById('hour').value);
            
            if (!year || year < 1900 || year > 2100) { alert("請輸入有效的出生年份"); return; }
            
            const lDate = solarToLunar(year, month, day);
            const engine = new ZiWeiEngine();
            const { palaces, lifePos } = engine.calculateChart(lDate[0], lDate[1], lDate[2], hourIdx);
            
            renderChart(palaces);
            renderAnalysis(name, lDate, palaces, lifePos);
            
            document.getElementById('result').classList.add('active');
            document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
        }

        // 初始執行
        initDays();
        document.getElementById('month').addEventListener('change', initDays);
        document.getElementById('year').addEventListener('change', initDays);
    </script>
</body>
</html>
